!function(){"use strict";function a(a,b,c,d,e,f){function g(){var c=a.url+"/"+a.sessionEndpoint;return d.when(b.oneUrl("session",c).get()).then(function(a){return a.userCtx?a:void d.reject("Session not found")})}function h(){return n=null,e.removeItem("user")}function i(a){return e.setItem("user",a)}function j(){return h().then(function(){return o.$broadcast("authenticationStateChange"),!0})}function k(b){return b.hasRole=function(a){var b=this;if(angular.isArray(a)){var c=a.filter(function(a){return b.roles.indexOf(a)>-1});return!!c.length}if(angular.isString(a))return this.roles.indexOf(a)>-1},b.isAdmin=function(){return this.hasRole(a.adminRoles)},console.log("user after decoration=",b),console.log("isAdmin=",b.isAdmin()),b}function l(){var a=new RegExp("casSession=.+");return a.test(document.cookie)}function m(){if(console.log("angular-eha.ums-auth getCurrentUser called"),n)return d.when(k(n));if(l()){var c=a.url+"/"+a.sessionEndpoint;return d.when(b.oneUrl("session",c).get()).then(function(a){console.log("getCurrentUser: session=",a);var b=a.userCtx;return b?(n=b,i(b),k(b)):void d.reject("Session not found")})}console.error("angular-eha.ums-auth: We have neither a session cookie nor a user in localForage.")}var n,o=f.$new(!0);return{signOut:j,getSession:g,getCurrentUser:m,on:o.$on.bind(o),trigger:o.$broadcast.bind(o),isAuthenticated:function(){return n?g():d.reject()}}}var b=angular.module("eha.ums-auth.auth.service",["restangular","LocalForageModule"]);b.provider("ehaUmsAuthService",["$localForageProvider",function(b){function c(a){return a.charAt(0).toUpperCase()+a.slice(1)}function d(a){var b=[a];return a.indexOf("-")>-1?b=a.split("-"):a.indexOf("_")>-1&&(b=a.split("_")),b=b.map(c),b.join("")}function e(a,b,c){return a.getCurrentUser().then(function(d){return!d||d.isAdmin()||d.hasRole(c)?d:(a.trigger("unauthorized"),b.reject("unauthorized"))}).catch(function(c){if("unauthorized"===c)throw c;return a.trigger("unauthenticated"),b.reject("unauthenticated")})}var f={localStorageNamespace:"eha",localStorageStoreName:"auth",adminRoles:["_admin"],sessionEndpoint:"_session"};this.config=function(a){f=angular.extend(f,a),b.config({name:f.localStorageNamespace,storeName:f.localStorageStoreName}),a.userRoles&&a.userRoles.forEach(function(a){var b="require"+d(a)+"User";this[b]=function(b,c){return e(b,c,[a])}}.bind(this))},this.requireAdminUser=function(a,b){return e(a,b,f.adminRoles)},this.requireAuthenticatedUser=function(a,b){return a.getCurrentUser().then(function(a){return a}).catch(function(c){return a.trigger("unauthenticated"),b.reject("unauthenticated")})},this.requireUserWithRoles=function(a){return function(b,c){return e(b,c,a)}},this.$get=["Restangular","$log","$q","$localForage","$rootScope",function(b,c,d,e,g){var h=b.withConfig(function(a){a.setBaseUrl(f.url),f.defaultHttpFields&&a.setDefaultHttpFields(f.defaultHttpFields)});return new a(f,h,c,d,e,g)}]}]),"undefined"!=typeof module&&module.exports&&(module.exports=b)}(),angular.module("eha.ums-auth.show-for-role.directive",[]).directive("ehaShowForRole",["ehaUmsAuthService","$animate","$parse","$q","$log",function(a,b,c,d,e){var f="ng-hide",g="ng-hide-animate";return{restrict:"A",link:function(h,i,j){function k(c){a.getCurrentUser().then(function(a){return a&&(a.hasRole(c)||a.isAdmin())?(b.removeClass(i,f,{tempClasses:g}),!0):d.reject("Role not found")}).catch(function(a){e.debug(a),b.addClass(i,f,{tempClasses:g})})}i.addClass("ng-hide");var l,m=c(j.ehaShowForRole)(h);if(angular.isArray(m))l=m;else{if(!angular.isString(m))throw Error("You must pass a string or an array of strings");l=[m]}k(l),a.on("authenticationStateChange",function(){k(l)})}}}]),angular.module("eha.ums-auth.show-authenticated.directive",[]).directive("ehaShowAuthenticated",["ehaUmsAuthService","$animate",function(a,b){var c="ng-hide",d="ng-hide-animate";return{restrict:"A",link:function(e,f){function g(){a.isAuthenticated().then(function(){b.removeClass(f,c,{tempClasses:d})}).catch(function(){b.addClass(f,c,{tempClasses:d})})}f.addClass("ng-hide"),g(),a.on("authenticationStateChange",g)}}}]),function(){"use strict";var a=angular.module("eha.ums-auth",["eha.ums-auth.auth.service","eha.ums-auth.show-for-role.directive","eha.ums-auth.show-authenticated.directive"]);"undefined"!=typeof module&&module.exports&&(module.exports=a)}();